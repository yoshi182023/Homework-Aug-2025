name: PR Title Check
on:
  pull_request:
    types: [opened, edited, synchronize, ready_for_review]

permissions:
  pull-requests: write
  contents: read

jobs:
  title:
    name: PR Title Check
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request || {};
            const repo = context.repo;
            const title = pr.title || "";
            const MARK = "<!-- pr-title-lint -->";

            async function upsert(lines){
              const body = [MARK].concat(lines).join("\n");
              const resp = await github.rest.issues.listComments({ owner: repo.owner, repo: repo.repo, issue_number: pr.number, per_page: 100 });
              const ex = (resp.data || []).find(c => c.body && c.body.indexOf(MARK) !== -1);
              if (ex) {
                await github.rest.issues.updateComment({ owner: repo.owner, repo: repo.repo, comment_id: ex.id, body });
              } else {
                await github.rest.issues.createComment({ owner: repo.owner, repo: repo.repo, issue_number: pr.number, body });
              }
            }
            async function cleanup(){
              const resp = await github.rest.issues.listComments({ owner: repo.owner, repo: repo.repo, issue_number: pr.number, per_page: 100 });
              const ex = (resp.data || []).find(c => c.body && c.body.indexOf(MARK) !== -1);
              if (ex) { await github.rest.issues.deleteComment({ owner: repo.owner, repo: repo.repo, comment_id: ex.id }); }
            }
            async function safeUpsert(lines){ try{ await upsert(lines); }catch(e){ core.warning("Cannot comment: " + (e.message||e)); } }
            async function safeCleanup(){ try{ await cleanup(); }catch(e){} }
            async function fail(lines){ await safeUpsert(lines); core.setFailed("PR title invalid"); }

            // è§„åˆ™ï¼šHW{æ•´æ•°} - {Name}ï¼›æ•´æ•°ä¸º 0 æˆ–æ­£æ•´æ•°ï¼›é»˜è®¤ä¸å…è®¸å‰å¯¼ 0ï¼ˆé™¤ 0 æœ¬èº«ï¼‰
            const re = /^HW(0|[1-9]\d*)\s*-\s*\S.*$/i;

            if (!re.test(title)) {
              await fail([
                "### ğŸš« PR æ ‡é¢˜æ ¼å¼é”™è¯¯",
                "",
                "ä½ çš„æ ‡é¢˜ï¼š`" + title + "`",
                "",
                "**è¦æ±‚æ ¼å¼**ï¼š`HW{æ•´æ•°} - {Name}`ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰",
                "- `æ•´æ•°` ä¸º `0` æˆ–æ­£æ•´æ•°ï¼ˆä¸å…è®¸å‰å¯¼ 0ï¼Œä¾‹å¦‚ `HW03` ä¸é€šè¿‡ï¼‰",
                "- `-` ä¸¤ä¾§å¯æœ‰ç©ºæ ¼",
                "- `{Name}` è‡³å°‘åŒ…å«ä¸€ä¸ªéç©ºç™½å­—ç¬¦",
                "",
                "**ç¤ºä¾‹ï¼ˆé€šè¿‡ï¼‰**ï¼š",
                "- `HW0 - Bean`",
                "- `HW3 - Zoey`",
                "- `HW42 - Performance tuning`",
                "",
                "**ç¤ºä¾‹ï¼ˆä¸é€šè¿‡ï¼‰**ï¼š",
                "- `hw3`ï¼ˆç¼ºå°‘ `- {Name}`ï¼‰",
                "- `HW-3 - test`ï¼ˆä¸æ˜¯éè´Ÿæ•´æ•°ï¼‰",
                "- `HW03 - test`ï¼ˆå‰å¯¼ 0ï¼‰",
                "- `bean hw3`"
              ]);
              return;
            }

            await safeCleanup();
            core.info("âœ… PR title OK");
