name: PR Title Check (comment + block)

on:
  pull_request:
    types: [opened, edited, synchronize, ready_for_review]

permissions:
  pull-requests: write   # éœ€è¦å†™æƒé™æ‰èƒ½è¯„è®º
  contents: read

jobs:
  check:
    if: ${{ !github.event.pull_request.draft }} # è‰ç¨¿ PR å¯è·³è¿‡ï¼›è¦æ ¡éªŒè‰ç¨¿å°±åˆ æ‰è¿™è¡Œ
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        id: lint
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title ?? "";
            // è§„åˆ™ï¼šHW{#} - {Name}ï¼›# âˆˆ [0,20]ï¼›è¿å­—ç¬¦ä¸¤ä¾§å¯æœ‰ç©ºæ ¼ï¼›Name è‡³å°‘å«ä¸€ä¸ªéç©ºç™½å­—ç¬¦ï¼›å¤§å°å†™ä¸æ•æ„Ÿ
            const re = /^HW(0|[1-9]|1[0-9]|20)\s*-\s*\S.*$/i;
            const marker = '<!-- pr-title-lint -->'; // ç”¨äºæŸ¥æ‰¾/æ›´æ–°åŒä¸€æ¡â€œç²˜æ€§è¯„è®ºâ€

            // Helper: upsert sticky comment
            async function upsertComment(body) {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                per_page: 100,
              });
              const existing = comments.find(c => c.body && c.body.includes(marker));
              if (existing) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existing.id,
                  body,
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body,
                });
              }
            }

            // Helper: cleanup old sticky comment on success
            async function deleteStickyIfExists() {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                per_page: 100,
              });
              const existing = comments.find(c => c.body && c.body.includes(marker));
              if (existing) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existing.id,
                });
              }
            }

            if (!re.test(title)) {
              const msg = [
                marker,
                `### ğŸš« PR title check failed`,
                ``,
                `**Your title:** \`${title}\``,
                ``,
                `**Why it failed**`,
                `- Must match: \`HW{#} - {Name}\``,
                `- \`#\` must be an integer from **0** to **20** (inclusive)`,
                `- Hyphen can have spaces around it`,
                `- {Name} must contain at least one non-space character`,
                ``,
                `**Correct examples**`,
                `- \`HW0 - Bean\``,
                `- \`HW3 - Zoey\``,
                `- \`HW20 - Performance tuning\``,
                ``,
                `**Not allowed**`,
                `- \`HW21 - xxx\` (out of range)`,
                `- \`HW3-\` (missing name)`,
                ``,
                `> Fix the title and this check will pass automatically.`
              ].join('\n');

              await upsertComment(msg);

              // å¯é€‰ï¼šæ”¹æˆâ€œè¯·æ±‚ä¿®æ”¹â€çš„ PR Reviewï¼ˆä¼šåœ¨ UI ä¸Šæ›´é†’ç›®ï¼‰
              // await github.rest.pulls.createReview({
              //   owner: context.repo.owner,
              //   repo: context.repo.repo,
              //   pull_number: pr.number,
              //   event: "REQUEST_CHANGES",
              //   body: msg,
              // });

              core.setFailed("PR title does not match required pattern: HW{0..20} - {Name}");
            } else {
              // é€šè¿‡æ—¶æ¸…ç†ä¹‹å‰çš„å¤±è´¥æç¤ºè¯„è®º
              await deleteStickyIfExists();
              core.info("PR title OK");
            }
